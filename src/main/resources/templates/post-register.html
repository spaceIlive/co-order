<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: header}" />
<body>
<div class="container">
    <div th:replace="~{fragments/bodyHeader :: bodyHeader}"/>
    
    <div class="py-5">
        <h2>ëª¨ì§‘ê¸€ ì‘ì„±</h2>
        
        <div class="alert alert-info">
            <strong>í˜¸ìŠ¤íŠ¸:</strong> <span th:text="${session.memberName}">í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì</span>
        </div>
        
        <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
            <strong>ì˜¤ë¥˜:</strong> <span th:text="${errorMessage}"></span>
        </div>
        
        <form role="form" th:action="@{/posts}" th:object="${postForm}" method="post" onsubmit="return validateForm()">
            <div class="mb-3">
                <label th:for="storeId" class="form-label">ê°€ê²Œ ì„ íƒ</label>
                <select th:field="*{storeId}" class="form-select" id="storeSelect" onchange="loadProducts()"
                        th:class="${#fields.hasErrors('storeId')} ? 'form-select fieldError' : 'form-select'">
                    <option value="">ê°€ê²Œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    <option th:each="store : ${stores}" 
                            th:value="${store.id}" 
                            th:text="${store.name}"></option>
                </select>
                <p th:if="${#fields.hasErrors('storeId')}" 
                   th:errors="*{storeId}" class="text-danger">Store Error</p>
            </div>
            
            <div class="mb-3">
                <label th:for="deadline" class="form-label">ë§ˆê° ì‹œê°„</label>
                <input type="datetime-local" th:field="*{deadline}" class="form-control"
                       th:class="${#fields.hasErrors('deadline')} ? 'form-control fieldError' : 'form-control'">
                <p th:if="${#fields.hasErrors('deadline')}" 
                   th:errors="*{deadline}" class="text-danger">Deadline Error</p>
            </div>
            
            <!-- ìƒí’ˆ ì„ íƒ ì˜ì—­ -->
            <div id="productSection" style="display: none;">
                <h5 class="mb-3">í˜¸ìŠ¤íŠ¸ ì£¼ë¬¸ ìƒí’ˆ ì„ íƒ</h5>
                <div class="card mb-3">
                    <div class="card-body" id="productList">
                        <!-- ë™ì ìœ¼ë¡œ ìƒí’ˆ ëª©ë¡ í‘œì‹œ -->
                    </div>
                </div>
                <div class="alert alert-secondary">
                    <strong>ì´ ì£¼ë¬¸ ê¸ˆì•¡:</strong> <span id="totalPrice">0</span>ì›
                </div>
                <p th:if="${#fields.hasErrors('productQuantities')}" 
                   th:errors="*{productQuantities}" class="text-danger">Product Error</p>
            </div>
            
            <div class="alert alert-warning">
                <p class="mb-1"><strong>ğŸ“Œ ì•ˆë‚´ ì‚¬í•­</strong></p>
                <p class="mb-0">â€¢ ìµœì†Œ ì¸ì›ì€ ê°€ê²Œ ê±°ë¦¬ì— ë”°ë¼ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
                <p class="mb-0">â€¢ ëª¨ì§‘ê¸€ ì‘ì„± ì‹œ í˜¸ìŠ¤íŠ¸ë„ ìƒí’ˆì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.</p>
            </div>
            
            <button type="submit" class="btn btn-primary">ì‘ì„±í•˜ê¸°</button>
            <a th:href="@{/posts}" class="btn btn-secondary">ì·¨ì†Œ</a>
        </form>
    </div>
    
    <div th:replace="~{fragments/footer :: footer}" />
</div>

<script>
let products = [];

async function loadProducts() {
    const storeId = document.getElementById('storeSelect').value;
    const productSection = document.getElementById('productSection');
    const productList = document.getElementById('productList');
    
    if (!storeId) {
        productSection.style.display = 'none';
        return;
    }
    
    try {
        const response = await fetch(`/api/stores/${storeId}/products`);
        products = await response.json();
        
        if (products.length === 0) {
            productList.innerHTML = '<p class="text-muted">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            productSection.style.display = 'block';
            return;
        }
        
        let html = '';
        products.forEach(product => {
            html += `
                <div class="row align-items-center mb-3 pb-3 border-bottom">
                    <div class="col-md-1 text-center">
                        <input type="checkbox" class="form-check-input" 
                               id="check_${product.id}" 
                               onclick="toggleQuantity(${product.id})"
                               style="width: 20px; height: 20px;">
                    </div>
                    <div class="col-md-5">
                        <h6 class="mb-1">${product.name}</h6>
                        <span class="text-primary fw-bold">${product.price.toLocaleString()}ì›</span>
                        <input type="hidden" id="price_${product.id}" value="${product.price}">
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <label class="input-group-text">ìˆ˜ëŸ‰</label>
                            <input type="number" class="form-control" 
                                   id="quantity_${product.id}" 
                                   name="productQuantities[${product.id}]"
                                   min="0" value="0" disabled 
                                   onchange="calculateTotal()"
                                   style="text-align: center;">
                        </div>
                    </div>
                    <div class="col-md-3 text-end">
                        <strong>ì†Œê³„:</strong> 
                        <span class="text-success fw-bold" id="subtotal_${product.id}">0</span>ì›
                    </div>
                </div>
            `;
        });
        
        productList.innerHTML = html;
        productSection.style.display = 'block';
        
    } catch (error) {
        console.error('ìƒí’ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
        productList.innerHTML = '<p class="text-danger">ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
        productSection.style.display = 'block';
    }
}

function toggleQuantity(productId) {
    const checkbox = document.getElementById('check_' + productId);
    const quantityInput = document.getElementById('quantity_' + productId);
    
    if (checkbox.checked) {
        quantityInput.disabled = false;
        quantityInput.value = 1;
    } else {
        quantityInput.disabled = true;
        quantityInput.value = 0;
    }
    calculateTotal();
}

function calculateTotal() {
    let total = 0;
    
    products.forEach(product => {
        const quantity = parseInt(document.getElementById('quantity_' + product.id).value) || 0;
        const price = parseInt(document.getElementById('price_' + product.id).value) || 0;
        const subtotal = quantity * price;
        
        document.getElementById('subtotal_' + product.id).textContent = subtotal.toLocaleString();
        total += subtotal;
    });
    
    document.getElementById('totalPrice').textContent = total.toLocaleString();
}

function validateForm() {
    const storeId = document.getElementById('storeSelect').value;
    if (!storeId) {
        alert('ê°€ê²Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return false;
    }
    
    const total = parseInt(document.getElementById('totalPrice').textContent.replace(/,/g, ''));
    if (total === 0) {
        alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return false;
    }
    
    return true;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ê°€ê²Œê°€ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ìƒí’ˆ ë¡œë“œ
window.addEventListener('DOMContentLoaded', function() {
    const storeId = document.getElementById('storeSelect').value;
    if (storeId) {
        loadProducts();
    }
});
</script>
<script th:src="@{/js/bootstrap.bundle.min.js}"></script>
</body>
</html>